apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: cap-deployment-replicas
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE","UPDATE"]
        resources: ["deployments"]
  # Accept parameters via a ConfigMap (wired by the Binding below)
  paramKind:
    apiVersion: v1
    kind: ConfigMap
  variables:
    - name: max
      expression: "int(params.data.maxReplicas)"
  validations:
    - expression: "object.spec.replicas == null || int(object.spec.replicas) <= variables.max"
      messageExpression: "'Replica count cannot exceed ' + string(variables.max) + ' for Deployments.'"
